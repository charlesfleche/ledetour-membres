# This snippet, to be included inside a `server` block, redirects
# /members.json to a non-anonymized version previously generated by
# get-members-json.py is the SSL client certificate is successfully
# verified

ssl_client_certificate /etc/ledetour-membres/ledetour-membres-ca.crt;
ssl_verify_client optional;



location /members.json {
  if ($ssl_client_verify = "SUCCESS") {
    rewrite ^/members.json$ /members-non-anonymized.json last;
  }
  rewrite ^/members.json$ /members-anonymized.json last;
}

location /members-non-anonymized.json {
  if ($ssl_client_verify != "SUCCESS") {
    return 403;
  }
  alias /var/lib/ledetour-membres/members-non-anonymized.json;
}

location /members-anonymized.json {
  alias /var/lib/ledetour-membres/members-anonymized.json;
}
